<body> 
<div class = "card">
<div class = "main_card" >
<section>
  <p class = "SidebarComponents"> <%= link_to "Orders", orders_restaurant_path, class:"SidebarComponentsRuby"%></p>
 <p class = "SidebarComponents"> <%= link_to "Menu", menu_restaurant_path, class:"SidebarComponentsRuby"%></p>
  <p class = "SidebarComponents"><%= link_to "Users", users_restaurant_path, class:"SidebarComponentsRuby"%></p>
  <p class = "SidebarComponents"><%= link_to "Reports", reports_restaurant_path, class:"SidebarComponentsRuby"%></p>
</section>
<section class = "style_card_reports">
<h1 class = "h1_reports_style"> Customer Reports </h1>
<%= form_with(url:"/reports_restaurant", method: "get", class:"style")  do |form| %>
   <p class = "dropdown">
   <%= form.select :name, User.all.map{ |t| t.name},{:prompt=>"Choose Customer name",:selected=>params[:name]},{class:"select_reports"}%>
   <%= form.select :status, ["Pending","Cancelled", "Add to queue", "Preparing", "Delivered","Confirm Success"], {:prompt=>"Choose status", :selected => params[:status]},{class:"select_reports"} %>
   <%= form.select :ordered, Order.all.map { |t| t.created_at.in_time_zone("Chennai").strftime("%b %d, %Y")}.uniq, {:prompt=>"Choose Ordered date", :selected => params[:ordered]},{class:"select_reports"} %> 
   <%= form.submit "Reports", class:"Reports" %>
   </p>
<% end %>
<% if params[:name].blank? && params[:status].blank?&& params[:ordered].blank?%>
<% customer_orders=Order.all%>
<% else %>
<% if params[:name] && params[:status].blank?&& params[:ordered].blank?%>
  <% customer_id = User.find_by(name: params[:name]).id %>
  <% customer_orders=Order.where(user_id: customer_id).to_a %>

<% elsif params[:status]&& params[:name].blank? && params[:ordered].blank? %>
  <% customer_orders=Order.where(status: params[:status]).to_a %>
  
<% elsif params[:ordered]&& params[:name].blank?&& params[:status].blank?%>
  <% customer_orders=Order.where(created_at: Date.parse(params[:ordered].to_s).beginning_of_day..Date.parse(params[:ordered].to_s).end_of_day).to_a %>

<% elsif params[:name]&& params[:status] && params[:ordered].blank? %>
  <% customer_id = User.find_by(name: params[:name]).id %>
   <% customer_orders=Order.where(user_id: customer_id).and(Order.where(status: params[:status])) %> 

<% elsif params[:name]&& params[:ordered] && params[:status].blank? %>
<% customer_id = User.find_by(name: params[:name]).id %>
<% customer_orders=Order.where(user_id: customer_id).and(Order.where(created_at: Date.parse(params[:ordered].to_s).beginning_of_day..Date.parse(params[:ordered].to_s).end_of_day)) %>

<% elsif params[:status]&& params[:ordered] && params[:name].blank? %>
<% customer_orders=Order.where(status: params[:status]).and(Order.where(created_at: Date.parse(params[:ordered].to_s).beginning_of_day..Date.parse(params[:ordered].to_s).end_of_day)) %>

<% elsif params[:name]&& params[:status] && params[:ordered] %>
<% customer_id = User.find_by(name: params[:name]).id %>
<% customer=Order.where(user_id: customer_id).and(Order.where(created_at: Date.parse(params[:ordered].to_s).beginning_of_day..Date.parse(params[:ordered].to_s).end_of_day)) %>
<% customer.to_a %>
<% customer_orders=Order.where(status: params[:status]).and(customer)%>

<% end %>
<% end %>
<br>
<br>
<table>
  <tr class = "tr-default">
    <th>Order Id</th>
    <th>Customer Name</th>
    <th>Mobile No</th>
    <th>Ordered On</th>
    <th>Status</th>
    <th>Items</th>
    <th>Total Cost</th>
  </tr>
  <% Order.cache(customer_orders).each do |report|%>
  <tr class = "tr">
    <td><%= report.id %></td>
    <td class = "user_name_reports" ><%= User.find(report.user_id).name%></td>
    <td><%= User.find(report.user_id).mobile_no %></td>
    <td><%= report.created_at.in_time_zone("Chennai").strftime("%b %d, %Y at %l:%M %p") %></td>
    <td class = "user_name"><%= report.status %></td>
    <td>
    <% cost=0%>
       <% report.menu.split("+") do |o| %>      
        <% str= o.split("*")%>
        <%= str[0]%>
        &nbsp;&nbsp;&nbsp;<%= "X "+str[1]%>
        <% cost=str[2].to_i+cost%>
        <br>
        <% end %>
    </td>
    <td><%= cost.to_s+" â‚¹"%></td>
  </tr>
  <% end %>
</table>
</div>
</div>
</body>